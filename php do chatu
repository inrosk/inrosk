<?php  

header("Content-type: text/xml");
header("Cache-Control: no-cache");

$servername = "localhost";
$username = "";
$password = "";

$conn = mysqli_connect($servername, $username, $password, "baza_mysql") or die("nie udalo siÄ™");
mysqli_set_charset($conn,"utf8");
date_default_timezone_set('Europe/Warsaw');
$time = (int)$_POST['time'];
$nick = mysqli_real_escape_string ($conn, $_POST['nick']);
$text = mysqli_real_escape_string ($conn, $_POST['text']);
$action = mysqli_real_escape_string ($conn, $_POST['action']);

if($action == "post")
{
mysqli_query($conn, "INSERT INTO wiadomosci (nick, tresc, czas) VALUES ('$nick', '$text', ".time().")");
    $tmp = mysqli_insert_id($conn) - 10;
    mysqli_query($conn, "DELETE FROM wiadomosci WHERE id <=".$tmp);
}

$results = mysqli_query($conn, "SELECT nick, tresc, czas FROM wiadomosci WHERE czas >".$time." ORDER BY id");

if (mysqli_num_rows($results) == 0)
    $status = 0;
else
    $status = 1;
echo "<?xml version='1.0' ?>";
echo "<wiadomosci>";
echo "<timestamp>".time()."</timestamp>";
echo "<status>".$status."</status>";
while($row = mysqli_fetch_array($results, MYSQLI_ASSOC))
{
    echo "<wiadomosc>";
    echo "<nick>".$row['nick']."</nick>";
    echo "<tresc>".$row['tresc']."</tresc>";
    if(date('d-m-y',$row['czas']) - date('d-m-y'))
        echo "<czas>".date('d-m-y H:i:s',$row['czas'])."</czas>";
    else 
    echo "<czas>".date('H:i:s',$row['czas'])."</czas>";
    echo "</wiadomosc>";
}


echo "</wiadomosci>";


mysqli_close($conn);

?>
